<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Monitoring Timeline</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/index.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .file-upload-section {
            background: #f8f9ff;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .file-upload-section h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        
        .file-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .file-input-group {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .file-input-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .file-input-group input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .chart-container {
            position: relative;
            height: 600px;
            margin: 30px 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .summary-stats {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-item h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        @media (max-width: 768px) {
            .file-inputs {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Data Monitoring Timeline</h1>
            <p>Visualizing Alma Database Updates and LIFY File Arrivals</p>
        </div>
        
        <div class="content">
            <div class="file-upload-section">
                <h3>Upload Your Data Files</h3>
                <p>Upload both log files to generate your monitoring timeline</p>
                
                <div class="file-inputs">
                    <div class="file-input-group">
                        <label for="almaFile">Alma Log File (filtered_alma_log.txt):</label>
                        <input type="file" id="almaFile" accept=".txt" />
                    </div>
                    <div class="file-input-group">
                        <label for="lifyFile">LIFY Arrival Log (CSV):</label>
                        <input type="file" id="lifyFile" accept=".csv" />
                    </div>
                </div>
                
                <button class="generate-btn" onclick="generateChart()">Generate Timeline</button>
            </div>
            
            <div id="statusMessage"></div>
            
            <div class="chart-container" id="chartContainer" style="display: none;">
                <canvas id="timelineChart"></canvas>
            </div>
            
            <div class="legend" id="legend" style="display: none;">
                <div class="legend-item">
                    <div class="legend-color" style="background: #3498db;"></div>
                    <span>Log Time</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    <span>Data Updated</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #27ae60;"></div>
                    <span>Data Available</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f39c12;"></div>
                    <span>Earliest File Arrival</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9b59b6;"></div>
                    <span>Latest File Arrival</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2ecc71;"></div>
                    <span>All Files Received</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #34495e;"></div>
                    <span>LIFY Cron Job (7:00 AM)</span>
                </div>
            </div>
            
            <div class="summary-stats" id="summaryStats" style="display: none;">
                <h3>Data Summary</h3>
                <div class="stats-grid" id="statsContent"></div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let almaData = [];
        let lifyData = [];

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }

        function timeToHours(timeStr) {
            const [hours, minutes, seconds] = timeStr.split(':').map(Number);
            return hours + minutes/60 + (seconds || 0)/3600;
        }

        function hoursToTimeString(hours) {
            const h = Math.floor(hours);
            const m = Math.floor((hours - h) * 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function parseAlmaLog(content) {
            const lines = content.split('\n').filter(line => line.trim());
            const data = [];
            
            for (const line of lines) {
                if (line.includes('Column0=') && line.includes('Column1=') && line.includes('Column2=')) {
                    const logTimeMatch = line.match(/\[([^\]]+)\]/);
                    const col2Match = line.match(/Column2=([^|]+)/);
                    const col1Match = line.match(/Column1=(.+)$/);
                    
                    if (logTimeMatch && col2Match && col1Match) {
                        try {
                            const logTime = new Date(logTimeMatch[1]);
                            const dataUpdated = new Date(col2Match[1].trim());
                            const dataAvailable = new Date(col1Match[1].trim());
                            
                            data.push({
                                date: logTime.toISOString().split('T')[0],
                                logTime: logTime,
                                dataUpdatedTime: dataUpdated,
                                dataAvailableTime: dataAvailable
                            });
                        } catch (e) {
                            console.warn('Failed to parse line:', line);
                        }
                    }
                }
            }
            return data;
        }

        function parseLifyLog(content) {
            const lines = content.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',');
            const timeColumns = headers.slice(1); // Skip Date column
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length >= 2) {
                    try {
                        const date = new Date(values[0]);
                        const times = [];
                        
                        for (let j = 1; j < values.length && j-1 < timeColumns.length; j++) {
                            if (values[j] && values[j].trim()) {
                                const timeMatch = values[j].match(/(\d{2}):(\d{2}):(\d{2})/);
                                if (timeMatch) {
                                    times.push(values[j].trim());
                                }
                            }
                        }
                        
                        if (times.length > 0) {
                            const timeHours = times.map(timeToHours);
                            data.push({
                                date: date.toISOString().split('T')[0],
                                earliestArrival: Math.min(...timeHours),
                                latestArrival: Math.max(...timeHours),
                                filesReceived: times.length,
                                totalExpected: timeColumns.length,
                                allFilesReceived: times.length === timeColumns.length
                            });
                        }
                    } catch (e) {
                        console.warn('Failed to parse LIFY line:', lines[i]);
                    }
                }
            }
            return data;
        }

        function adjustTimeForChart(hours) {
            // Adjust times so evening times (18:00-23:59) appear before early morning (00:00-12:00)
            if (hours >= 18) {
                return hours; // Evening times stay as-is
            } else {
                return hours + 24; // Early morning times get shifted up
            }
        }

        function createTimelineChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            // Get all unique dates
            const allDates = [...new Set([
                ...almaData.map(d => d.date),
                ...lifyData.map(d => d.date)
            ])].sort();
            
            const datasets = [];
            
            // Alma data points
            if (almaData.length > 0) {
                datasets.push({
                    label: 'Log Time',
                    data: almaData.map(d => ({
                        x: d.date,
                        y: adjustTimeForChart(timeToHours(d.logTime.toTimeString().split(' ')[0]))
                    })),
                    backgroundColor: '#3498db',
                    borderColor: '#3498db',
                    pointStyle: 'circle',
                    pointRadius: 6
                });
                
                datasets.push({
                    label: 'Data Updated',
                    data: almaData.map(d => ({
                        x: d.date,
                        y: adjustTimeForChart(timeToHours(d.dataUpdatedTime.toTimeString().split(' ')[0]))
                    })),
                    backgroundColor: '#e74c3c',
                    borderColor: '#e74c3c',
                    pointStyle: 'rect',
                    pointRadius: 6
                });
                
                datasets.push({
                    label: 'Data Available',
                    data: almaData.map(d => ({
                        x: d.date,
                        y: adjustTimeForChart(timeToHours(d.dataAvailableTime.toTimeString().split(' ')[0]))
                    })),
                    backgroundColor: '#27ae60',
                    borderColor: '#27ae60',
                    pointStyle: 'rectRot',
                    pointRadius: 6
                });
            }
            
            // LIFY data points
            if (lifyData.length > 0) {
                datasets.push({
                    label: 'Earliest File Arrival',
                    data: lifyData.map(d => ({
                        x: d.date,
                        y: adjustTimeForChart(d.earliestArrival)
                    })),
                    backgroundColor: '#f39c12',
                    borderColor: '#f39c12',
                    pointStyle: 'triangle',
                    pointRadius: 8
                });
                
                datasets.push({
                    label: 'Latest File Arrival',
                    data: lifyData.map(d => ({
                        x: d.date,
                        y: adjustTimeForChart(d.latestArrival)
                    })),
                    backgroundColor: '#9b59b6',
                    borderColor: '#9b59b6',
                    pointStyle: 'triangle',
                    pointRadius: 8,
                    rotation: 180
                });
                
                // Add markers for days when all files were received
                const allFilesData = lifyData
                    .filter(d => d.allFilesReceived)
                    .map(d => ({
                        x: d.date,
                        y: adjustTimeForChart(d.latestArrival) + 0.5
                    }));
                
                if (allFilesData.length > 0) {
                    datasets.push({
                        label: 'All Files Received',
                        data: allFilesData,
                        backgroundColor: '#2ecc71',
                        borderColor: '#2ecc71',
                        pointStyle: 'star',
                        pointRadius: 10
                    });
                }
            }
            
            // LIFY Cron Job line
            datasets.push({
                label: 'LIFY Cron Job (7:00 AM)',
                data: allDates.map(date => ({
                    x: date,
                    y: adjustTimeForChart(7)
                })),
                backgroundColor: '#34495e',
                borderColor: '#34495e',
                borderDash: [5, 5],
                pointRadius: 0,
                showLine: true,
                fill: false
            });
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'scatter',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Data Processing and File Arrival Timeline',
                            font: { size: 18, weight: 'bold' },
                            padding: 20
                        },
                        legend: {
                            display: false // We'll use our custom legend
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MM/DD'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        y: {
                            min: 17,
                            max: 36,
                            ticks: {
                                stepSize: 2,
                                callback: function(value) {
                                    const times = {
                                        18: '18:00', 20: '20:00', 22: '22:00', 
                                        24: '00:00', 26: '02:00', 28: '04:00',
                                        30: '06:00', 32: '08:00', 34: '10:00', 36: '12:00'
                                    };
                                    return times[value] || '';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Time of Day (24-hour)',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        function updateSummaryStats() {
            const statsContent = document.getElementById('statsContent');
            let html = '';
            
            if (almaData.length > 0) {
                const dateRange = `${almaData[0].date} to ${almaData[almaData.length - 1].date}`;
                html += `
                    <div class="stat-item">
                        <h4>Alma Log Data</h4>
                        <p><strong>Total entries:</strong> ${almaData.length}</p>
                        <p><strong>Date range:</strong> ${dateRange}</p>
                    </div>
                `;
            }
            
            if (lifyData.length > 0) {
                const allFilesCount = lifyData.filter(d => d.allFilesReceived).length;
                const avgFiles = (lifyData.reduce((sum, d) => sum + d.filesReceived, 0) / lifyData.length).toFixed(1);
                
                html += `
                    <div class="stat-item">
                        <h4>LIFY Arrival Data</h4>
                        <p><strong>Total days:</strong> ${lifyData.length}</p>
                        <p><strong>Days with all files:</strong> ${allFilesCount}</p>
                        <p><strong>Average files per day:</strong> ${avgFiles}</p>
                        <p><strong>Expected files per day:</strong> ${lifyData[0]?.totalExpected || 'N/A'}</p>
                    </div>
                `;
            }
            
            statsContent.innerHTML = html;
        }

        async function generateChart() {
            const almaFile = document.getElementById('almaFile').files[0];
            const lifyFile = document.getElementById('lifyFile').files[0];
            
            if (!almaFile || !lifyFile) {
                showStatus('Please select both files before generating the chart.', 'error');
                return;
            }
            
            showStatus('Processing files...', 'info');
            
            try {
                // Read files
                const almaContent = await almaFile.text();
                const lifyContent = await lifyFile.text();
                
                // Parse data
                almaData = parseAlmaLog(almaContent);
                lifyData = parseLifyLog(lifyContent);
                
                if (almaData.length === 0 && lifyData.length === 0) {
                    showStatus('No valid data found in the uploaded files. Please check the file formats.', 'error');
                    return;
                }
                
                // Create chart
                createTimelineChart();
                updateSummaryStats();
                
                // Show chart and related elements
                document.getElementById('chartContainer').style.display = 'block';
                document.getElementById('legend').style.display = 'block';
                document.getElementById('summaryStats').style.display = 'block';
                
                showStatus(`Successfully processed ${almaData.length} Alma entries and ${lifyData.length} LIFY entries.`, 'success');
                
            } catch (error) {
                console.error('Error processing files:', error);
                showStatus('Error processing files. Please check the file formats and try again.', 'error');
            }
        }

        // Add drag and drop functionality
        function setupDragAndDrop() {
            const fileSection = document.querySelector('.file-upload-section');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileSection.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                fileSection.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                fileSection.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight(e) {
                fileSection.style.background = '#e8f4fd';
                fileSection.style.borderColor = '#3498db';
            }
            
            function unhighlight(e) {
                fileSection.style.background = '#f8f9ff';
                fileSection.style.borderColor = '#667eea';
            }
            
            fileSection.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    // Auto-assign files based on extension/name
                    Array.from(files).forEach(file => {
                        if (file.name.includes('alma') || file.name.endsWith('.txt')) {
                            document.getElementById('almaFile').files = createFileList([file]);
                        } else if (file.name.includes('lify') || file.name.endsWith('.csv')) {
                            document.getElementById('lifyFile').files = createFileList([file]);
                        }
                    });
                }
            }
            
            function createFileList(files) {
                const dt = new DataTransfer();
                files.forEach(file => dt.items.add(file));
                return dt.files;
            }
        }
        
        // Initialize drag and drop when page loads
        document.addEventListener('DOMContentLoaded', setupDragAndDrop);
    </script>
</body>
</html>
