import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from datetime import datetime, time
import numpy as np
import re

class DataMonitoringVisualizer:
    def __init__(self):
        self.alma_data = None
        self.lify_data = None
        
    def parse_alma_log(self, file_path):
        """Parse the filtered_alma_log.txt file"""
        data = []
        
        with open(file_path, 'r') as f:
            lines = f.readlines()
            
        # Skip header line if it exists
        start_line = 1 if lines[0].startswith('Log Time') else 0
        
        for line in lines[start_line:]:
            if line.strip():
                # Parse format: [2025-08-18 17:13:02] Column0=0 | Column2=2025-08-17T19:05:00 | Column1=2025-08-18T01:01:31
                match = re.match(r'\[([^\]]+)\] Column0=\d+ \| Column2=([^|]+) \| Column1=(.+)', line.strip())
                if match:
                    log_time = datetime.strptime(match.group(1), '%Y-%m-%d %H:%M:%S')
                    data_updated = datetime.strptime(match.group(2), '%Y-%m-%dT%H:%M:%S')
                    data_available = datetime.strptime(match.group(3), '%Y-%m-%dT%H:%M:%S')
                    
                    data.append({
                        'date': log_time.date(),
                        'log_time': log_time.time(),
                        'data_updated_time': data_updated.time(),
                        'data_available_time': data_available.time()
                    })
        
        self.alma_data = pd.DataFrame(data)
        return self.alma_data
    
    def parse_lify_log(self, file_path):
        """Parse the LIFY Arrival Log CSV file"""
        df = pd.read_csv(file_path)
        
        # Convert date column to datetime
        df['Date'] = pd.to_datetime(df['Date'])
        df['date'] = df['Date'].dt.date
        
        # Get all time columns (exclude Date column)
        time_columns = [col for col in df.columns if col != 'Date' and col != 'date']
        
        processed_data = []
        for _, row in df.iterrows():
            times = []
            for col in time_columns:
                if pd.notna(row[col]) and str(row[col]) != '':
                    try:
                        time_obj = datetime.strptime(str(row[col]), '%H:%M:%S').time()
                        times.append(time_obj)
                    except ValueError:
                        continue
            
            if times:
                processed_data.append({
                    'date': row['date'],
                    'earliest_arrival': min(times),
                    'latest_arrival': max(times),
                    'files_received': len(times),
                    'total_expected_files': len(time_columns),
                    'all_files_received': len(times) == len(time_columns)
                })
        
        self.lify_data = pd.DataFrame(processed_data)
        return self.lify_data
    
    def time_to_hours(self, t):
        """Convert time object to hours for y-axis plotting"""
        return t.hour + t.minute/60 + t.second/3600
    
    def create_visualization(self, figsize=(16, 10), save_path=None):
        """Create the comprehensive data monitoring timeline visualization"""
        if self.alma_data is None or self.lify_data is None:
            raise ValueError("Please parse both log files first using parse_alma_log() and parse_lify_log()")
        
        fig, ax = plt.subplots(figsize=figsize)
        
        # Get all unique dates and sort them
        alma_dates = set(self.alma_data['date']) if not self.alma_data.empty else set()
        lify_dates = set(self.lify_data['date']) if not self.lify_data.empty else set()
        all_dates = sorted(alma_dates.union(lify_dates))
        
        if not all_dates:
            raise ValueError("No valid dates found in the data")
        
        # Convert dates to matplotlib date numbers for x-axis
        date_nums = mdates.date2num(all_dates)
        date_to_num = dict(zip(all_dates, date_nums))
        
        # Plot Alma data
        for i, row in self.alma_data.iterrows():
            if row['date'] in date_to_num:
                x_pos = date_to_num[row['date']]
                
                # Convert times to hours for y-axis
                log_y = self.time_to_hours(row['log_time'])
                updated_y = self.time_to_hours(row['data_updated_time'])
                available_y = self.time_to_hours(row['data_available_time'])
                
                # Plot points
                ax.scatter(x_pos, log_y, color='blue', s=40, alpha=0.8, marker='o', 
                          label='Log Time' if i == 0 else "", zorder=5)
                ax.scatter(x_pos, updated_y, color='red', s=40, alpha=0.8, marker='s', 
                          label='Data Updated' if i == 0 else "", zorder=5)
                ax.scatter(x_pos, available_y, color='green', s=40, alpha=0.8, marker='D', 
                          label='Data Available' if i == 0 else "", zorder=5)
                
                # Shade the processing window between updated and available times
                y_min = min(updated_y, available_y)
                y_max = max(updated_y, available_y)
                ax.fill_between([x_pos-0.25, x_pos+0.25], y_min, y_max, 
                               alpha=0.2, color='yellow', 
                               label='Processing Window' if i == 0 else "", zorder=1)
        
        # Plot LIFY data
        for i, row in self.lify_data.iterrows():
            if row['date'] in date_to_num:
                x_pos = date_to_num[row['date']]
                
                # Convert times to hours
                earliest_y = self.time_to_hours(row['earliest_arrival'])
                latest_y = self.time_to_hours(row['latest_arrival'])
                
                # Plot earliest and latest arrival times
                ax.scatter(x_pos, earliest_y, color='orange', s=60, marker='^', alpha=0.8,
                          label='Earliest File Arrival' if i == 0 else "", zorder=5)
                ax.scatter(x_pos, latest_y, color='purple', s=60, marker='v', alpha=0.8,
                          label='Latest File Arrival' if i == 0 else "", zorder=5)
                
                # Shade area between earliest and latest arrivals
                ax.fill_between([x_pos-0.2, x_pos+0.2], earliest_y, latest_y,
                               alpha=0.15, color='orange',
                               label='File Arrival Window' if i == 0 else "", zorder=2)
                
                # Add indicator for complete file delivery (all 14 files)
                if row['all_files_received']:
                    ax.scatter(x_pos, latest_y + 0.3, color='darkgreen', s=80, marker='*',
                              label='All Files Received' if i == 0 else "", zorder=6)
        
        # Add LIFY Cron Job line at 7:00 AM
        cron_time = 7.0  # 7:00 AM
        ax.axhline(y=cron_time, color='black', linestyle='--', linewidth=2, alpha=0.7,
                   label='LIFY Cron Job (7:00 AM)', zorder=3)
        
        # Set up the axes
        ax.set_xlabel('Date', fontsize=12, fontweight='bold')
        ax.set_ylabel('Time of Day (24-hour)', fontsize=12, fontweight='bold')
        ax.set_title('Data Processing and File Arrival Timeline', fontsize=16, fontweight='bold', pad=20)
        
        # Format x-axis with dates
        ax.xaxis.set_major_formatter(mdates.DateFormatter('%m/%d'))
        ax.xaxis.set_major_locator(mdates.DayLocator(interval=1))
        plt.setp(ax.xaxis.get_majorticklabels(), rotation=45, ha='right')
        
        # Set y-axis to show times from 18:00 to 12:00 (next day)
        y_ticks = [18, 20, 22, 24, 2, 4, 6, 8, 10, 12]
        y_tick_labels = ['18:00', '20:00', '22:00', '00:00', '02:00', '04:00', 
                        '06:00', '08:00', '10:00', '12:00']
        
        # Handle 24-hour wraparound for y-axis
        y_ticks_adjusted = []
        for tick in y_ticks:
            if tick >= 18:  # Evening times (18:00-23:59)
                y_ticks_adjusted.append(tick)
            else:  # Early morning times (00:00-12:00) - add 24 to put them above evening
                y_ticks_adjusted.append(tick + 24 if tick <= 12 else tick)
        
        ax.set_yticks(y_ticks_adjusted)
        ax.set_yticklabels(y_tick_labels)
        ax.set_ylim(17, 36)  # 17 (5 PM) to 36 (12 PM next day)
        
        # Add grid for better readability
        ax.grid(True, alpha=0.3, linestyle='-', linewidth=0.5)
        
        # Add legend
        ax.legend(bbox_to_anchor=(1.05, 1), loc='upper left', frameon=True, fancybox=True, shadow=True)
        
        # Adjust layout to prevent legend cutoff
        plt.tight_layout()
        
        # Save if path provided
        if save_path:
            plt.savefig(save_path, dpi=300, bbox_inches='tight')
            print(f"Visualization saved to: {save_path}")
        
        plt.show()
        
        # Print summary statistics
        self.print_summary()
    
    def print_summary(self):
        """Print summary statistics about the data"""
        print("\n" + "="*60)
        print("DATA SUMMARY")
        print("="*60)
        
        if self.alma_data is not None and not self.alma_data.empty:
            print(f"Alma Log Data:")
            print(f"  • Total entries: {len(self.alma_data)}")
            print(f"  • Date range: {self.alma_data['date'].min()} to {self.alma_data['date'].max()}")
        
        if self.lify_data is not None and not self.lify_data.empty:
            print(f"LIFY Arrival Data:")
            print(f"  • Total days: {len(self.lify_data)}")
            print(f"  • Date range: {self.lify_data['date'].min()} to {self.lify_data['date'].max()}")
            print(f"  • Days with all files received: {self.lify_data['all_files_received'].sum()}")
            if 'total_expected_files' in self.lify_data.columns:
                print(f"  • Expected files per day: {self.lify_data['total_expected_files'].iloc[0]}")

# Usage example:
def main():
    """Example usage of the DataMonitoringVisualizer"""
    visualizer = DataMonitoringVisualizer()
    
    # Parse the data files
    try:
        alma_data = visualizer.parse_alma_log('filtered_alma_log.txt')
        lify_data = visualizer.parse_lify_log('lify_arrival_log.csv')
        
        print("Data parsed successfully!")
        print(f"Alma entries: {len(alma_data)}")
        print(f"LIFY entries: {len(lify_data)}")
        
        # Create the visualization
        visualizer.create_visualization(figsize=(16, 10), save_path='data_monitoring_timeline.png')
        
    except FileNotFoundError as e:
        print(f"File not found: {e}")
        print("Please ensure both 'filtered_alma_log.txt' and 'lify_arrival_log.csv' are in the current directory")
    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    main()
