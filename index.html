<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Monitoring Timeline</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .controls-section {
            background: #f8f9ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .file-status-group {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6c757d;
        }
        
        .status-indicator.loaded { background: #28a745; }
        .status-indicator.error { background: #dc3545; }
        
        .date-range-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .date-range-control label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .date-range-control select {
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        .chart-container {
            position: relative;
            height: 700px;
            margin: 30px 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            padding: 25px;
        }
        
        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 25px 0;
            padding: 25px;
            background: #f8f9ff;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        
        .legend-shape {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }
        
        .legend-circle { border-radius: 50%; }
        .legend-square { border-radius: 2px; }
        .legend-diamond { transform: rotate(45deg); border-radius: 2px; }
        .legend-triangle {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 14px solid;
        }
        .legend-triangle.down {
            border-bottom: none;
            border-top: 14px solid;
        }
        .legend-star {
            position: relative;
            background: currentColor;
            width: 16px;
            height: 16px;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Data Monitoring Timeline</h1>
            <p>Visualizing Alma Database Updates and LIFY File Arrivals</p>
        </div>
        
        <div class="content">
            <div class="controls-section">
                <div class="file-status-group">
                    <div class="status-item">
                        <div class="status-indicator" id="almaIndicator"></div>
                        <span>Alma Log: <span id="almaStatus">Loading...</span></span>
                    </div>
                    <div class="status-item">
                        <div class="status-indicator" id="lifyIndicator"></div>
                        <span>LIFY Log: <span id="lifyStatus">Loading...</span></span>
                    </div>
                </div>
                
                <div class="date-range-control">
                    <label for="dayRange">Show:</label>
                    <select id="dayRange" onchange="updateDateRange()">
                        <option value="7">Last 7 days</option>
                        <option value="14">Last 14 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="all">All data</option>
                    </select>
                </div>
            </div>
            
            <div id="statusMessage"></div>
            
            <div class="chart-container" id="chartContainer" style="display: none;">
                <canvas id="timelineChart"></canvas>
            </div>
            
            <div class="legend" id="legend" style="display: none;">
                <div class="legend-item">
                    <div class="legend-shape legend-circle" style="background: #3498db;"></div>
                    <span>Log Time</span>
                </div>
                <div class="legend-item">
                    <div class="legend-shape legend-square" style="background: #e74c3c;"></div>
                    <span>Data Updated</span>
                </div>
                <div class="legend-item">
                    <div class="legend-shape legend-diamond" style="background: #27ae60;"></div>
                    <span>Data Available</span>
                </div>
                <div class="legend-item">
                    <div class="legend-triangle" style="border-bottom-color: #f39c12;"></div>
                    <span>Earliest File Arrival</span>
                </div>
                <div class="legend-item">
                    <div class="legend-triangle down" style="border-top-color: #9b59b6;"></div>
                    <span>Latest File Arrival</span>
                </div>
                <div class="legend-item">
                    <div class="legend-star" style="color: #2ecc71;"></div>
                    <span>All Files Received</span>
                </div>
                <div class="legend-item">
                    <div style="width: 30px; height: 3px; background: #34495e; border-radius: 2px; border-top: 2px dashed #34495e;"></div>
                    <span>LIFY Cron Job (7:00 AM)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let allAlmaData = [];
        let allLifyData = [];
        let filteredAlmaData = [];
        let filteredLifyData = [];

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }

        function timeToHours(timeStr) {
            const [hours, minutes, seconds] = timeStr.split(':').map(Number);
            return hours + minutes/60 + (seconds || 0)/3600;
        }

        function timeToChartY(hours) {
            // Convert actual hours to chart Y position
            // 18:00 -> 0, 19:00 -> 1, 20:00 -> 2, 21:00 -> 3, 22:00 -> 4, 23:00 -> 5
            // 00:00 -> 6, 01:00 -> 7, 02:00 -> 8, ..., 12:00 -> 18
            
            if (hours >= 18) {
                return hours - 18; // 18:00->0, 19:00->1, ..., 23:00->5
            } else {
                return hours + 6;  // 00:00->6, 01:00->7, ..., 12:00->18
            }
        }

        function parseAlmaLog(content) {
            const lines = content.split('\n').filter(line => line.trim());
            const data = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('Log Time') || line.includes('Data Updated Time')) {
                    continue;
                }
                
                if (line.includes('Column0=') && line.includes('Column1=') && line.includes('Column2=')) {
                    const logTimeMatch = line.match(/\[([^\]]+)\]/);
                    const col2Match = line.match(/Column2=([^|]+)/);
                    const col1Match = line.match(/Column1=(.+)$/);
                    
                    if (logTimeMatch && col2Match && col1Match) {
                        try {
                            const logTime = new Date(logTimeMatch[1].trim());
                            const dataUpdated = new Date(col2Match[1].trim());
                            const dataAvailable = new Date(col1Match[1].trim());
                            
                            if (!isNaN(logTime.getTime()) && !isNaN(dataUpdated.getTime()) && !isNaN(dataAvailable.getTime())) {
                                data.push({
                                    date: logTime.toISOString().split('T')[0],
                                    logTime: logTime,
                                    dataUpdatedTime: dataUpdated,
                                    dataAvailableTime: dataAvailable
                                });
                            }
                        } catch (e) {
                            console.warn('Failed to parse line:', line);
                        }
                    }
                }
            }
            
            return data.sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        function parseLifyLog(content) {
            const lines = content.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',');
            const timeColumns = headers.slice(1);
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length >= 2) {
                    try {
                        const date = new Date(values[0]);
                        const times = [];
                        
                        for (let j = 1; j < values.length && j-1 < timeColumns.length; j++) {
                            if (values[j] && values[j].trim()) {
                                const timeMatch = values[j].match(/(\d{2}):(\d{2}):(\d{2})/);
                                if (timeMatch) {
                                    times.push(timeToHours(values[j].trim()));
                                }
                            }
                        }
                        
                        if (times.length > 0) {
                            data.push({
                                date: date.toISOString().split('T')[0],
                                earliestArrival: Math.min(...times),
                                latestArrival: Math.max(...times),
                                filesReceived: times.length,
                                totalExpected: timeColumns.length,
                                allFilesReceived: times.length === timeColumns.length
                            });
                        }
                    } catch (e) {
                        console.warn('Failed to parse LIFY line:', lines[i]);
                    }
                }
            }
            
            return data.sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        function filterDataByDays(days) {
            if (days === 'all') {
                filteredAlmaData = [...allAlmaData];
                filteredLifyData = [...allLifyData];
                return;
            }
            
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - parseInt(days));
            const cutoffStr = cutoffDate.toISOString().split('T')[0];
            
            filteredAlmaData = allAlmaData.filter(d => d.date >= cutoffStr);
            filteredLifyData = allLifyData.filter(d => d.date >= cutoffStr);
        }

        function updateDateRange() {
            const dayRange = document.getElementById('dayRange').value;
            filterDataByDays(dayRange);
            if (filteredAlmaData.length > 0 || filteredLifyData.length > 0) {
                createChart();
            }
        }

        function createChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            // Get all unique dates
            const allDates = [...new Set([
                ...filteredAlmaData.map(d => d.date),
                ...filteredLifyData.map(d => d.date)
            ])].sort();
            
            if (allDates.length === 0) {
                showStatus('No data available for the selected time range.', 'info');
                return;
            }
            
            // Create datasets
            const datasets = [];
            
            // Add shaded processing windows FIRST (background)
            filteredAlmaData.forEach((d, index) => {
                const x = allDates.indexOf(d.date);
                const updatedY = timeToChartY(timeToHours(d.dataUpdatedTime.toTimeString().split(' ')[0]));
                const availableY = timeToChartY(timeToHours(d.dataAvailableTime.toTimeString().split(' ')[0]));
                
                // Create filled rectangle for processing window
                const windowData = [];
                for (let offset = -0.4; offset <= 0.4; offset += 0.05) {
                    windowData.push({ x: x + offset, y: updatedY });
                    windowData.push({ x: x + offset, y: availableY });
                }
                
                datasets.push({
                    label: index === 0 ? 'Processing Window' : '',
                    data: windowData,
                    backgroundColor: 'rgba(255, 193, 7, 0.25)',
                    borderColor: 'transparent',
                    pointRadius: 1,
                    showLine: false
                });
            });
            
            // Add shaded file arrival windows
            filteredLifyData.forEach((d, index) => {
                const x = allDates.indexOf(d.date);
                const windowData = [];
                for (let offset = -0.3; offset <= 0.3; offset += 0.05) {
                    windowData.push({ x: x + offset, y: timeToChartY(d.earliestArrival) });
                    windowData.push({ x: x + offset, y: timeToChartY(d.latestArrival) });
                }
                
                datasets.push({
                    label: index === 0 ? 'File Arrival Window' : '',
                    data: windowData,
                    backgroundColor: 'rgba(255, 152, 0, 0.2)',
                    borderColor: 'transparent',
                    pointRadius: 1,
                    showLine: false
                });
            });
            
            // LIFY Cron Job line (7:00 AM)
            datasets.push({
                label: 'LIFY Cron Job (7:00 AM)',
                data: allDates.map((date, index) => ({ x: index, y: timeToChartY(7) })),
                borderColor: '#34495e',
                backgroundColor: 'transparent',
                borderDash: [10, 5],
                borderWidth: 3,
                pointRadius: 0,
                showLine: true,
                fill: false
            });
            
            // Alma data points (foreground)
            if (filteredAlmaData.length > 0) {
                datasets.push({
                    label: 'Log Time',
                    data: filteredAlmaData.map(d => ({
                        x: allDates.indexOf(d.date),
                        y: timeToChartY(timeToHours(d.logTime.toTimeString().split(' ')[0]))
                    })),
                    backgroundColor: '#3498db',
                    borderColor: '#ffffff',
                    borderWidth: 3,
                    pointRadius: 8,
                    pointHoverRadius: 12,
                    showLine: false
                });
                
                datasets.push({
                    label: 'Data Updated',
                    data: filteredAlmaData.map(d => ({
                        x: allDates.indexOf(d.date),
                        y: timeToChartY(timeToHours(d.dataUpdatedTime.toTimeString().split(' ')[0]))
                    })),
                    backgroundColor: '#e74c3c',
                    borderColor: '#ffffff',
                    borderWidth: 3,
                    pointStyle: 'rect',
                    pointRadius: 8,
                    pointHoverRadius: 12,
                    showLine: false
                });
                
                datasets.push({
                    label: 'Data Available',
                    data: filteredAlmaData.map(d => ({
                        x: allDates.indexOf(d.date),
                        y: timeToChartY(timeToHours(d.dataAvailableTime.toTimeString().split(' ')[0]))
                    })),
                    backgroundColor: '#27ae60',
                    borderColor: '#ffffff',
                    borderWidth: 3,
                    pointStyle: 'rectRot',
                    pointRadius: 8,
                    pointHoverRadius: 12,
                    showLine: false
                });
            }
            
            // LIFY data points
            if (filteredLifyData.length > 0) {
                datasets.push({
                    label: 'Earliest File Arrival',
                    data: filteredLifyData.map(d => ({
                        x: allDates.indexOf(d.date),
                        y: timeToChartY(d.earliestArrival)
                    })),
                    backgroundColor: '#f39c12',
                    borderColor: '#ffffff',
                    borderWidth: 3,
                    pointStyle: 'triangle',
                    pointRadius: 10,
                    pointHoverRadius: 14,
                    showLine: false
                });
                
                datasets.push({
                    label: 'Latest File Arrival',
                    data: filteredLifyData.map(d => ({
                        x: allDates.indexOf(d.date),
                        y: timeToChartY(d.latestArrival)
                    })),
                    backgroundColor: '#9b59b6',
                    borderColor: '#ffffff',
                    borderWidth: 3,
                    pointStyle: 'triangle',
                    pointRadius: 10,
                    rotation: 180,
                    pointHoverRadius: 14,
                    showLine: false
                });
                
                // All files received markers
                const allFilesData = filteredLifyData
                    .filter(d => d.allFilesReceived)
                    .map(d => ({
                        x: allDates.indexOf(d.date),
                        y: timeToChartY(d.latestArrival) - 0.5
                    }));
                
                if (allFilesData.length > 0) {
                    datasets.push({
                        label: 'All Files Received',
                        data: allFilesData,
                        backgroundColor: '#2ecc71',
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        pointStyle: 'star',
                        pointRadius: 12,
                        pointHoverRadius: 16,
                        showLine: false
                    });
                }
            }
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'scatter',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Data Processing and File Arrival Timeline',
                            font: { size: 20, weight: 'bold' },
                            padding: 25,
                            color: '#2c3e50'
                        },
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(44, 62, 80, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#34495e',
                            borderWidth: 2,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            min: -0.5,
                            max: allDates.length - 0.5,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    const index = Math.round(value);
                                    if (index >= 0 && index < allDates.length) {
                                        const date = new Date(allDates[index]);
                                        return (date.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                               date.getDate().toString().padStart(2, '0');
                                    }
                                    return '';
                                },
                                font: { size: 12, weight: '600' },
                                color: '#2c3e50'
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                font: { size: 16, weight: 'bold' },
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(52, 73, 94, 0.1)',
                                lineWidth: 1
                            }
                        },
                        y: {
                            // Y-axis from 18:00 at top to 12:00 at bottom
                            min: 0,   // Top of scale (18:00)
                            max: 18,  // Bottom of scale (12:00)
                            ticks: {
                                stepSize: 2,
                                callback: function(value) {
                                    const timeMap = {
                                        0: '18:00',
                                        2: '20:00',
                                        4: '22:00',
                                        6: '00:00',
                                        8: '02:00',
                                        10: '04:00',
                                        12: '06:00',
                                        14: '08:00',
                                        16: '10:00',
                                        18: '12:00'
                                    };
                                    return timeMap[value] || '';
                                },
                                font: { size: 12, weight: '600' },
                                color: '#2c3e50'
                            },
                            title: {
                                display: true,
                                text: 'Time of Day (24-hour)',
                                font: { size: 16, weight: 'bold' },
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(52, 73, 94, 0.15)',
                                lineWidth: 1
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'point'
                    }
                }
            });
            
            // Show elements
            document.getElementById('chartContainer').style.display = 'block';
            document.getElementById('legend').style.display = 'block';
            
            showStatus(`Chart generated with ${filteredAlmaData.length} Alma entries and ${filteredLifyData.length} LIFY entries.`, 'success');
        }

        async function loadDataFiles() {
            try {
                const almaResponse = await fetch('filtered_alma_log.txt');
                const lifyResponse = await fetch('lify_arrival_log.csv');
                
                let almaLoaded = false;
                let lifyLoaded = false;
                
                if (almaResponse.ok) {
                    const content = await almaResponse.text();
                    allAlmaData = parseAlmaLog(content);
                    almaLoaded = true;
                    document.getElementById('almaStatus').textContent = 'Loaded';
                    document.getElementById('almaIndicator').className = 'status-indicator loaded';
                } else {
                    document.getElementById('almaStatus').textContent = 'Not found';
                    document.getElementById('almaIndicator').className = 'status-indicator error';
                }
                
                if (lifyResponse.ok) {
                    const content = await lifyResponse.text();
                    allLifyData = parseLifyLog(content);
                    lifyLoaded = true;
                    document.getElementById('lifyStatus').textContent = 'Loaded';
                    document.getElementById('lifyIndicator').className = 'status-indicator loaded';
                } else {
                    document.getElementById('lifyStatus').textContent = 'Not found';
                    document.getElementById('lifyIndicator').className = 'status-indicator error';
                }
                
                if (almaLoaded || lifyLoaded) {
                    filterDataByDays('7'); // Default to 7 days
                    createChart();
                } else {
                    showStatus('Could not load data files. Please ensure files are in the same directory.', 'error');
                }
                
            } catch (error) {
                console.error('Error loading files:', error);
                showStatus('Error loading data files from server.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', loadDataFiles);
    </script>
</body>
</html>
